<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="cheer up"><meta name="baidu-site-verification" content="9pSIuwCbvi"><meta name="google-site-verification" content="YzcCTjF6VoVlNAtL37_S4vFjzFwYTAFZzD51Il2IGKY"><title>SSD å¤ç° | WenHuiZhou</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SSD å¤ç°</h1><a id="logo" href="/.">WenHuiZhou</a><p class="description">perperï¼ˆæ‰“èµ·ç²¾ç¥ï¼ï¼‰</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SSD å¤ç°</h1><div class="post-meta">Mar 29, 2019<span> | </span><span class="category"><a href="/categories/è®ºæ–‡å¤ç°/">è®ºæ–‡å¤ç°</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span></div><a class="disqus-comment-count" href="/2019/03/29/SSD-å¤ç°/#vcomment"><span class="valine-comment-count" data-xid="/2019/03/29/SSD-å¤ç°/"></span><span> æ¡è¯„è®º</span></a><div class="post-content"><p>SSDæ˜¯ç»å…¸çš„one-stageç›®æ ‡æ£€æµ‹æ¡†æ¶ï¼Œåœ¨é€Ÿåº¦å’Œç²¾åº¦ä¸Šéƒ½æ¯”Faster RCNNï¼ŒYOLOï¼ˆV1ï¼Ÿï¼‰è¦æ›´èƒœä¸€ç­¹ã€‚è¿™æ¬¡å¤ç°SSDä½œä¸ºç†è§£ç½‘ç»œä»¥åŠå­¦ä¹ pytorchçš„ä¸€ä¸ªæœºä¼šï¼Œè¿™ç¯‡æ–‡ç« å°†å°½å¯èƒ½çš„è¯¦ç»†è®°å½•SSDçš„å¤ç°ç»†èŠ‚ã€‚ï¼ˆå¥½å¤§çš„flagğŸï¼‰</p>
<a id="more"></a>
<p>åœ¨å¤ç°SSDä¹‹å‰ï¼Œæˆ‘æƒ³å°±pytorchçš„ä¸¤å¤§éƒ¨ä»¶è¿›è¡Œä¸€ä¸‹ä»‹ç»ï¼Œåˆ†åˆ«æ˜¯æ•°æ®é›†æ¨¡å—ï¼ˆ<code>torch.utils.data.Dataset</code>ï¼‰ä»¥åŠç½‘ç»œæ¨¡å—(<code>torch.nn.Module</code>)ã€‚</p>
<h3 id="æ•°æ®é›†æ¨¡å—"><a href="#æ•°æ®é›†æ¨¡å—" class="headerlink" title="æ•°æ®é›†æ¨¡å—"></a>æ•°æ®é›†æ¨¡å—</h3><p> pytorchæ•°æ®è¯»å–ä¸»è¦æœ‰ä¸‰ä¸ªç±»ï¼š</p>
<ul>
<li>Dataset </li>
<li>DataLoader </li>
<li>DataLoaderIter</li>
</ul>
<p>ä»–ä»¬ä½¿ç”¨çš„æ–¹å¼ä¸ºDatasetåšä¸ºå‚æ•°ä¼ å…¥DatasetLoaderä¸­ï¼ŒDataLoaderåšä¸ºå‚æ•°ä¼ å…¥DataLoaderIterä¸­ã€‚</p>
<p>å› æ­¤å®Œæˆpytorchæ•°æ®é›†è¯»å–æ¨¡å—ç¬¬ä¸€æ­¥è¦åšçš„æ˜¯ï¼š</p>
<p>ã€1ã€‘å®šä¹‰<strong>æ•°æ®é›†ç±»</strong>ã€‚</p>
<p><code>torch.utils.data.Dataset</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå› æ­¤ç»§æ‰¿Datasetéœ€è¦å®ç°ä»–çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œ<code>__len__()</code>ï¼Œ<code>__getitem__()</code>ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> data</span><br><span class="line">data_set = &#123;<span class="number">1</span>:<span class="string">'a'</span>,<span class="number">2</span>:<span class="string">'b'</span>,<span class="number">3</span>:<span class="string">'c'</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomDataset</span><span class="params">(data.Dataset)</span>:</span><span class="comment">#éœ€è¦ç»§æ‰¿data.Dataset</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 1. Initialize file path or list of file names.</span></span><br><span class="line">        self.data = data_set</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="comment"># æ¯æ¬¡è¯»å–ä¸€å¼ å›¾ç‰‡ä»¥åŠå¯¹åº”çš„labelï¼Œ</span></span><br><span class="line">        <span class="comment"># å¯ä»¥å¯¹å›¾ç‰‡è¿›è¡Œä¸€äº›flipç­‰æ“ä½œï¼ˆtorchvision.Transform).</span></span><br><span class="line">        <span class="comment"># æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªå«æœ‰(image,label)çš„pair</span></span><br><span class="line">        <span class="comment"># å¯ä»¥åœ¨init()å‡½æ•°çš„ä½ç½®å¤„ç”Ÿæˆcsv_reader,æˆ–æ˜¯ä¸€äº›listï¼Œé›†åˆ</span></span><br><span class="line">        <span class="keyword">return</span> index, self.data[index]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.data)</span><br></pre></td></tr></table></figure>
<p>å¯¹äºè¿™ä¸ªDatasetè¿™ä¸ªç±»ï¼Œåªè¦å®ç°äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œç„¶åæ¯æ¬¡è°ƒç”¨çš„çš„æ—¶å€™éƒ½èƒ½å‡ºæ¥ä¸€ä¸ªimgï¼Œlabelï¼Œå†…éƒ¨æ— è®ºæ˜¯listï¼Œgeneratoréƒ½æ˜¯å¯è¡Œçš„ã€‚</p>
<p>åœ¨<code>__getitem__()</code> å¤„å¯ä»¥æ‰§è¡Œä¸€äº›å›¾ç‰‡å˜æ¢ç­‰å·¥ä½œï¼Œtorchvision.transformsä¸­æœ‰ç€è®¸å¤šå¯¹å›¾ç‰‡çš„å¢å¼ºæ“ä½œã€‚å¸¸ç”¨çš„æœ‰<code>Resize</code> , <code>RandomCrop</code> , <code>Normalize</code> , <code>ToTensor</code> (è¿™ä¸ª<strong>æä¸ºé‡è¦</strong>, å¯ä»¥æŠŠä¸€ä¸ªPILæˆ–numpyå›¾ç‰‡è½¬ä¸º<code>torch.Tensor</code>ï¼‰</p>
<p>ã€2ã€‘å®šä¹‰dataLoader</p>
<p>dataLoaderçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class torch.utils.data.DataLoader(dataset, batch_size=1, shuffle=False, sampler=None, batch_sampler=None, num_workers=0, collate_fn=&lt;function default_collate&gt;, pin_memory=False, drop_last=False)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>dataset</code>å³ä¸Šé¢å®šä¹‰çš„datasetï¼Œ<code>batch_size</code>æŒ‡ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¾“å‡ºçš„æ ·æœ¬ä¸ªæ•°ã€‚<code>num_workers</code>æŒ‡çº¿ç¨‹æ•°ï¼Œå½“å¤§äºç­‰äº1æ—¶å°±è¡¨ç¤ºå¤šçº¿ç¨‹ã€‚<code>collate_fn</code> ç”¨äºå®šåˆ¶è¾“å‡ºçš„batchï¼Œé€šè¿‡ä¼ å…¥lambdaè¡¨è¾¾å¼æ¥å®ç°ï¼Œå³å½“ä¸€å¼ å›¾ç‰‡å¯¹åº”å¤šä¸ªè¾¹æ¡†çš„æ—¶å€™ï¼Œå°±éœ€è¦è¿›è¡Œå›¾ç‰‡ä»¥åŠè¾¹æ¡†çš„åŒ¹é…ã€‚</p>
<p>dataLoaderè¿˜å®ç°äº†ä¸€ä¸ª<code>__iter__()</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¾“å…¥ä¸ºdataLoaderï¼Œè¾“å‡ºä¸ºdataLoaderIterï¼Œæ˜¯ä¸€ä¸ªè¿­ä»£å™¨ã€‚</p>
<p>å…·ä½“ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dataset = CustomClass()</span><br><span class="line">dataloader = data.DataLoader(dataset,batch_size = <span class="number">10</span>,...)</span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> dataloader:</span><br><span class="line">  <span class="comment"># data[0]ä¸ºå›¾ç‰‡</span></span><br><span class="line">  <span class="comment"># data[1]ä¸ºæ ‡å‡†</span></span><br><span class="line">  <span class="comment"># å…±æœ‰10å¯¹</span></span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h3 id="ç½‘ç»œç»“æ„æ¨¡å—"><a href="#ç½‘ç»œç»“æ„æ¨¡å—" class="headerlink" title="ç½‘ç»œç»“æ„æ¨¡å—"></a>ç½‘ç»œç»“æ„æ¨¡å—</h3><p>pytorch ä½¿ç”¨<code>nn.Module</code> æ¥æ„å»ºç½‘ç»œï¼Œåœ¨pytorchä¸­æ¯ä¸€ä¸ªç½‘ç»œå±‚éƒ½æ˜¯ä¸€ä¸ª<code>nn.Module</code>ç±»ï¼Œå¹¶ä¸”ç±»ä¹‹é—´ç›¸äº’åµŒå¥—ã€‚<code>nn.Module</code>ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯</p>
<p><code>__init__()</code> ï¼šå®Œæˆé€»è¾‘æ¨¡å—çš„åˆå§‹åŒ–ã€‚</p>
<p><code>forward()</code>ï¼šå®Œæˆè®¡ç®—å›¾çš„æ­£å‘ä¼ é€’çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚nn.Linearæ¨¡å—çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLinear</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">()</span>:</span></span><br><span class="line">    super(MyLinear,self).__init__()</span><br><span class="line">    </span><br><span class="line">    self.w = nn.Parameter(torch.randn(outp,inp))</span><br><span class="line">    self.b = nn.Parameter(torch.randn(outp))</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self,x)</span>:</span></span><br><span class="line">    x = x @ self.w.t() + self.b</span><br><span class="line">    <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<p>pytorchä¸­æä¾›äº†è®¸å¤šç°æˆçš„ç±»å¯ä¾›ä½¿ç”¨ï¼š</p>
<ul>
<li><code>nn.conV2d</code></li>
<li><code>nn.MaxPool2d</code></li>
<li><code>nn.ReLu</code></li>
<li><code>nn.BatchNorm2d</code></li>
</ul>
<p>åŒæ—¶<code>nn.Sequential</code>å®ç°äº†ä¸€ä¸ªåºåˆ—ï¼Œç”¨æ¥æ„å»ºç½‘ç»œæ¨¡å—ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.net = nn.Sequential(</span><br><span class="line">    nn.Conv2d(in_size,out_size,kernel_size,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">    nn.MaxPool2d(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">    nn.ReLu()</span><br><span class="line">   nn.BatchNorm2d(<span class="number">32</span>)</span><br><span class="line">  ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥å°†æŒ‰ç…§ç½‘ç»œå±‚ä»ä¸Šåˆ°ä¸‹è¿›è¡Œå‚æ•°çš„ä¼ é€’ã€‚</p>
<p>æ­¤å¤–nn.Moduleç±»è¿˜ä¼šå¯¹ç½‘ç»œçš„å‚æ•°è¿›è¡Œç®¡ç†ï¼Œ<code>nn.parameters()</code>ä¸­å°†ä¼šä¿å­˜ç€ç½‘ç»œæ‰€æœ‰çš„å‚æ•°ã€‚ä¾¿äºå‚æ•°çš„ç®¡ç†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨nn.moduleæ„å»ºè®¸å¤šçš„ç½‘ç»œå±‚ï¼Œç„¶åé€šè¿‡è¾“å…¥è¾“å‡ºä¼ å€¼çš„æ–¹å¼å°†ä»–ä»¬è¿æˆä¸€ä¸ªè®¡ç®—å›¾ã€‚</p>
<p>ä¸‹é¢å°†æŒ‰ç…§æ•°æ®çš„è¯»å…¥ï¼Œç½‘ç»œçš„æ­å»ºï¼Œç½‘ç»œçš„è®­ç»ƒï¼Œä»¥åŠæ•ˆæœçš„è¯„ä¼°å‡ ä¸ªæ–¹é¢è¿›è¡Œã€‚</p>
<h3 id="SSD-å¤ç°"><a href="#SSD-å¤ç°" class="headerlink" title="SSD å¤ç°"></a>SSD å¤ç°</h3><p>å‚è€ƒ<a href="https://github.com/amdegroot/ssd.pytorch" target="_blank" rel="noopener">githubé“¾æ¥</a>ã€‚</p>
<p><strong>ã€1ã€‘æ•°æ®çš„å‡†å¤‡</strong></p>
<p>æ•°æ®é›†æ˜¯ä¸€äº›ç”±è§†é¢‘åˆ‡å¸§è€Œæ¥çš„å›¾ç‰‡ï¼Œä¸€ç§’åˆ‡ä¸€å¸§ï¼Œå¯¹äºæ¯å¼ å›¾ï¼Œç”±ç›¸åº”çš„æ ‡æ³¨ä¿¡æ¯ï¼Œæ ‡æ³¨ä¿¡æ¯csvæ ¼å¼ã€‚é€šè¿‡è¯»å–csvæ•°æ®é›†çš„æ–¹å¼ï¼Œæ¥å®Œæˆæ•°æ®çš„è¯»å–ï¼ˆgithubç‰ˆæœ¬ä¸ºä½¿ç”¨pycocotoolè¯»å–æ•°æ®ï¼‰ã€‚é€šè¿‡ç»§æ‰¿data.Datasetä»¥åŠå®ç°dataLoaderçš„æ–¹å¼æ¥è·å–æ•°æ®ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> data</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="comment"># csvæ ¼å¼ä¸ºï¼šurl,x1,y1,x2,y2,label</span></span><br><span class="line">TRAIN_ROOT = <span class="string">'./data/train_dataset.csv'</span></span><br><span class="line">VAL_ROOT   = <span class="string">'./data/val_dataset.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detection_collate</span><span class="params">(batch)</span>:</span></span><br><span class="line">    targets = []</span><br><span class="line">    imgs    = []</span><br><span class="line">    <span class="keyword">for</span> sample <span class="keyword">in</span> batch:</span><br><span class="line">        imgs.append(sample[<span class="number">0</span>])</span><br><span class="line">        targets.append(sample[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> imgs,targets</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">csv_loader</span><span class="params">(data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,data_root,transform = transforms.ToTensor<span class="params">()</span>)</span>:</span></span><br><span class="line">        self.data_root  = data_root</span><br><span class="line">        self.dataset    = &#123;&#125;</span><br><span class="line">        self.imgs_index = &#123;&#125;</span><br><span class="line">        self.transform  = transform</span><br><span class="line">        self.index      = <span class="number">0</span></span><br><span class="line">        <span class="keyword">with</span> open(self.data_root,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            lines = csv.reader(f)</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                <span class="keyword">if</span> line[<span class="number">0</span>] <span class="keyword">in</span> self.dataset:</span><br><span class="line">                    self.dataset[line[<span class="number">0</span>]].append(line[<span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.dataset[line[<span class="number">0</span>]] = [line[<span class="number">1</span>:<span class="number">5</span>],]</span><br><span class="line">                    self.imgs_index[self.index] = line[<span class="number">0</span>]</span><br><span class="line">                    self.index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self,index)</span>:</span></span><br><span class="line">        img_path = self.imgs_index[index]</span><br><span class="line">        label    = self.dataset[img_path]</span><br><span class="line">        img      = cv2.imread(img_path)</span><br><span class="line">        img      = self.transform(img)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(label)):</span><br><span class="line">            label[i][<span class="number">0</span>] = float(label[i][<span class="number">0</span>])</span><br><span class="line">            label[i][<span class="number">1</span>] = float(label[i][<span class="number">1</span>])</span><br><span class="line">            label[i][<span class="number">2</span>] = float(label[i][<span class="number">2</span>])</span><br><span class="line">            label[i][<span class="number">3</span>] = float(label[i][<span class="number">3</span>])</span><br><span class="line">        label  = np.array(label)</span><br><span class="line">        <span class="keyword">return</span> img,label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.index+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">dataset    = csv_loader(TRAIN_ROOT)</span><br><span class="line">dataloader = data.DataLoader(dataset,batch_size = <span class="number">2</span>,collate_fn = detection_collate)</span><br><span class="line"><span class="keyword">for</span> img,label <span class="keyword">in</span> dataloader:</span><br><span class="line">    print(img)</span><br><span class="line">    print(label)</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œå¯ä»¥çœ‹å‡ºæˆ‘ä»¬ä½¿ç”¨detection_collateæ–¹æ³•æ¥å¯¹æ¯ä¸ªbatch sizeä¸­è¯»åˆ°çš„æ•°æ®è¿›è¡ŒäºŒæ¬¡ç»„ç»‡ã€‚</p>
<p>ã€2ã€‘ç½‘ç»œçš„æ„å»º</p>
<p>æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å°†ç½‘ç»œæ­å»ºèµ·æ¥ï¼Œç„¶åå°†æ•°æ®è¾“å…¥ã€‚</p>
<p>ssdçš„ç½‘ç»œçš„backboneæ˜¯vggç½‘ç»œï¼Œåˆ©ç”¨vggç½‘ç»œæå–å›¾ç‰‡ç‰¹å¾ã€‚</p>
<p>vggçš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="./images/CNNnet/VGG16.png" alt=""></p>
<p>å®ç°backboneçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">base = &#123;</span><br><span class="line">    <span class="string">'300'</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">'M'</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">'M'</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">'C'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>,</span><br><span class="line">            <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>],</span><br><span class="line">    <span class="string">'512'</span>: [],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="hard-negative-mining"><a href="#hard-negative-mining" class="headerlink" title="hard negative mining"></a>hard negative mining</h3><p>SSD ä¸­å¯¹feature mapä½ç½®çš„æå–6ä¸ªæˆ–4ä¸ªè¾¹æ¡†ï¼Œè¿™äº›è¾¹æ¡†çš„å°ºå¯¸ç”±ä¸€äº›è¶…å‚æ•°å†³å®šã€‚åœ¨è¿›è¡Œç½‘ç»œè®­ç»ƒä¹‹å‰ï¼Œéœ€è¦å¯¹ç”Ÿæˆçš„è¿™äº›è¾¹æ¡†è¿›è¡Œæ­£è´Ÿæ ·æœ¬çš„æ ‡æ³¨ï¼Œæ ‡æ³¨çš„æ ‡å‡†åœ¨äºè¿™äº›è¾¹æ¡†ä¸GTè¾¹æ¡†çš„IoUé‡åˆåº¦ï¼Œå¦‚æœé‡åˆåº¦å¤§äº0.5ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸ªè¾¹æ¡†æ˜¯è¯æ ·æœ¬ï¼Œå°äº0.3è¡¨ç¤ºè¿™ä¸ªè¾¹æ¡†æ˜¯è´Ÿæ ·æœ¬ã€‚</p>
<p>åœ¨å¯¹æ­£è´Ÿæ ·æœ¬è¿›è¡Œæ ‡æ³¨æ—¶ï¼Œä¸€èˆ¬è¦ä¿è¯æ­£æ ·æœ¬ï¼šè´Ÿæ ·æœ¬çš„ä¸ªæ•°ä¸º1:3ã€‚ä½†æ˜¯å¯¹äºä¸€å¼ å›¾ç‰‡æ¥è¯´ï¼Œå…¶ä¸Šå¤§éƒ¨åˆ†çš„æ¡†éƒ½æ˜¯è´Ÿæ ·æœ¬ï¼Œå› æ­¤éœ€è¦è¿›è¡Œhard negative miningå°†ä¸€äº›å¾—åˆ†è¾ƒé«˜çš„negative åšä¸ºhard negativeã€‚</p>
<p>hard negative miningä¸€èˆ¬æ˜¯ï¼Œæœ‰æ­£è´Ÿæ ·æœ¬ï¼Œç„¶ååˆ†ç±»å™¨åˆ†å‡ºæ¥ä¸€äº›åˆ†é”™çš„è´Ÿæ ·æœ¬ï¼ˆå®¹æ˜“å°†è´Ÿæ ·æœ¬çœ‹æˆæ­£æ ·æœ¬çš„é‚£äº›æ ·æœ¬ï¼‰ï¼Œå³å‡é˜³æ€§(false positive )ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¯¹è´Ÿæ ·æœ¬åˆ†ç±»æ—¶å€™ï¼Œlossæ¯”è¾ƒå¤§ï¼ˆlabelä¸predictionç›¸å·®è¾ƒå¤§ï¼‰çš„é‚£äº›æ ·æœ¬ï¼Œè¿™äº›å°±æ˜¯hard negative/å›°éš¾æ ·æœ¬ï¼Œè¿›è¡Œé‡æ–°è®­ç»ƒã€‚</p>
<p>ç½‘ç»œæ­å»ºéƒ¨åˆ†ä¸»è¦ç»§æ‰¿nn.Moduleæ¨¡å—ï¼Œç»§æ‰¿initä»¥åŠforwardæ¨¡å—ï¼Œå®ç°ç½‘ç»œç»“æ„çš„æ­å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•å„å±‚çš„channel</span></span><br><span class="line">base   = [<span class="number">64</span>,<span class="number">64</span>,<span class="string">'M'</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="string">'M'</span>,<span class="number">256</span>,<span class="number">256</span>,<span class="number">256</span>,<span class="string">'C'</span>,<span class="number">512</span>,<span class="number">512</span>,<span class="number">512</span>,<span class="string">'M'</span>,<span class="number">512</span>,<span class="number">512</span>,<span class="number">512</span>] <span class="comment"># Mè¡¨ç¤ºfloorï¼ˆè¾¹è§’èˆå¼ƒï¼‰æ–¹å¼çš„Maxpoolingï¼ŒCè¡¨ç¤ºceilï¼ˆè¡¥å…¨ï¼‰æ–¹å¼çš„Maxpooling</span></span><br><span class="line"><span class="comment"># vggä¹‹åçš„å„å„å±‚</span></span><br><span class="line">extras = [<span class="number">256</span>,<span class="string">'S'</span>,<span class="number">512</span>,<span class="number">128</span>,<span class="string">'S'</span>,<span class="number">256</span>,<span class="number">128</span>,<span class="number">256</span>,<span class="number">128</span>,<span class="number">256</span>]</span><br><span class="line"><span class="comment">#æ¯ä¸€å±‚æ¯ä¸ªåƒç´ ä½ç½®å°†å–å‡ºçš„è¾¹æ¡†ä¸ªæ•°</span></span><br><span class="line">mboxes = [<span class="number">4</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vgg</span><span class="params">(base,input_channel,batch_norm=None)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    base: å„å±‚çš„channel</span></span><br><span class="line"><span class="string">    input_channelï¼šä¼ å…¥æ•°æ®çš„ç»´åº¦</span></span><br><span class="line"><span class="string">    batch_normï¼šæ˜¯å¦ä½¿ç”¨bn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿™ä¸ªå‡½æ•°ä¸»è¦ä½¿ç”¨ä¸€ä¸ªlistï¼Œå°†æ¯ä¸€å±‚çš„å‡½æ•°å­˜å‚¨èµ·æ¥ï¼Œç”¨baseæ¥æ§åˆ¶å½“å‰å±‚æ˜¯ä»€ä¹ˆ</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    layers = []</span><br><span class="line">    in_channels = input_channel</span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> base:</span><br><span class="line">        <span class="keyword">if</span>   v == <span class="string">'M'</span>:<span class="comment"># è¡¨ç¤ºæ˜¯ä¸€ä¸ªmaxpooling</span></span><br><span class="line">            layers += [nn.MaxPool2d(kernel_size=<span class="number">2</span>,stride=<span class="number">2</span>)]</span><br><span class="line">        <span class="keyword">elif</span> v == <span class="string">'C'</span>:</span><br><span class="line">            layers += [nn.MaxPool2d(kernel_size=<span class="number">2</span>,stride=<span class="number">2</span>,ceil_mode=<span class="keyword">True</span>)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            conv2d = nn.Conv2d(in_channels,v,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> batch_norm:</span><br><span class="line">                layers += [conv2d,nn.BatchNorm2d(v),nn.ReLU(inplace=<span class="keyword">True</span>)] <span class="comment"># inplace=True æŒ‡å®ƒå°†ç›´æ¥ä¿®æ”¹inputçš„å€¼ï¼Œè€Œä¸é‡æ–°åˆ†é…ç©ºé—´</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                layers += [conv2d,nn.ReLU(inplace=<span class="keyword">True</span>)]</span><br><span class="line">            in_channels = v</span><br><span class="line">    pool5   = nn.MaxPool2d(kernel_size=<span class="number">3</span>,stride=<span class="number">1</span>,padding=<span class="number">1</span>)</span><br><span class="line">    conv6   = nn.Conv2d(<span class="number">512</span>,<span class="number">1024</span>,kernel_size=<span class="number">3</span>,padding=<span class="number">6</span>,dilation=<span class="number">6</span>)</span><br><span class="line">    conv7   = nn.Conv2d(<span class="number">1024</span>,<span class="number">1024</span>,kernel_size=<span class="number">1</span>)</span><br><span class="line">    layers += [pool5,conv6,nn.ReLU(inplace=<span class="keyword">True</span>),conv7,nn.ReLU(inplace=<span class="keyword">True</span>)]</span><br><span class="line">    <span class="keyword">return</span> layers</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_extras</span><span class="params">(extras,in_channel,batch_norm=None)</span>:</span></span><br><span class="line">    <span class="comment"># extra layers added to vgg for feature scaling</span></span><br><span class="line">    layers = []</span><br><span class="line">    in_channels = in_channel</span><br><span class="line">    flag = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> enumerate(extras):</span><br><span class="line">        <span class="keyword">if</span> in_channels!=<span class="string">'S'</span>:</span><br><span class="line">            <span class="keyword">if</span> v == <span class="string">'S'</span>:</span><br><span class="line">                layers += [nn.Conv2d(in_channels,extras[k+<span class="number">1</span>],kernel_size=(<span class="number">1</span>,<span class="number">3</span>)[flag],stride=<span class="number">2</span>,padding=<span class="number">1</span>)]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                layers += [nn.Conv2d(in_channels,v,kernel_size=(<span class="number">1</span>,<span class="number">3</span>)[flag])]</span><br><span class="line">            flag = <span class="keyword">not</span> flag</span><br><span class="line">        in_channels = v</span><br><span class="line">    <span class="keyword">return</span> layers</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multibox</span><span class="params">(vgg,extras_layers,mbox,num_classes)</span>:</span></span><br><span class="line">    loc_layers  = []</span><br><span class="line">    conf_layers = []</span><br><span class="line">    vgg_source  = [<span class="number">21</span>,<span class="number">-2</span>] <span class="comment"># vggçš„21å±‚å³conv4_3,å’Œ-2å±‚å³fc7</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> enumerate(vgg_source):</span><br><span class="line">        loc_layers  += [nn.Conv2d(vgg[v].out_channels,mbox[k]*<span class="number">4</span>,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)]           <span class="comment"># location æœ‰å››ä¸ªå‚æ•°</span></span><br><span class="line">        conf_layers += [nn.Conv2d(vgg[v].out_channels,mbox[k]*num_classes,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)] <span class="comment"># ç±»åˆ«é¢„æµ‹å°†æœ‰class_numä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> enumerate(extras_layers[<span class="number">1</span>::<span class="number">2</span>],<span class="number">2</span>):     <span class="comment"># è¿™é‡Œå°±æ˜¯è¯´å–extrasä¸­å¥‡æ•°å±‚ï¼Œç„¶åå–bounding boxï¼Œä»ç¬¬äºŒå±‚å¼€å§‹</span></span><br><span class="line">        loc_layers  += [nn.Conv2d(v.out_channels,mbox[k]*<span class="number">4</span>,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)]</span><br><span class="line">        conf_layers += [nn.Conv2d(v.out_channels,mbox[k]*num_classes,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">return</span> vgg,extras_layers,(loc_layers,conf_layers)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">priorBox</span><span class="params">(obejct)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    åœ¨feature mapä¸Šè®¡ç®—åˆå§‹è¾¹æ¡†çš„åæ ‡</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,cfg)</span>:</span></span><br><span class="line">        <span class="comment"># å°†configä¸­çš„ä¸€äº›è¶…å‚èµ‹å€¼è¿‡æ¥</span></span><br><span class="line">        self.image_size    = cfg[<span class="string">'min_dim'</span>]</span><br><span class="line">        self.num_priors    = len(cfg[<span class="string">'aspect_ratios'</span>])</span><br><span class="line">        self.variance      = cfg[<span class="string">'variance'</span>] <span class="keyword">or</span> [<span class="number">0.1</span>]</span><br><span class="line">        self.feature_maps  = cfg[<span class="string">'feature_maps'</span>]</span><br><span class="line">        self.min_sizes     = cfg[<span class="string">'min_sizes'</span>]</span><br><span class="line">        self.max_sizes     = cfg[<span class="string">'max_sizes'</span>]</span><br><span class="line">        self.steps         = cfg[<span class="string">'steps'</span>]</span><br><span class="line">        self.aspect_ratios = cfg[<span class="string">'aspect_ratios'</span>]</span><br><span class="line">        self.clip          = cfg[<span class="string">'clip'</span>]</span><br><span class="line">        self.version       = cfg[<span class="string">'name'</span>]</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> self.variance:</span><br><span class="line">            <span class="keyword">if</span> v &lt;= <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">'Variances must be greater than 0'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self)</span>:</span></span><br><span class="line">            mean = []</span><br><span class="line">            <span class="keyword">for</span> k ,f <span class="keyword">in</span> enumerate(self.feature_maps):</span><br><span class="line">                f_k = self.image_size / self.steps[k]</span><br><span class="line">                s_k = self.min_sizes[k] / self.image_size   </span><br><span class="line">                s_k_prime = sqrt(s_k*(self.max_sizes[k]/self.image_size))</span><br><span class="line">                <span class="keyword">for</span> i,j <span class="keyword">in</span> product(range(f),repeat=<span class="number">2</span>):</span><br><span class="line">                    <span class="comment"># unit center x,y</span></span><br><span class="line">                    cx  = (j + <span class="number">0.5</span>) / f_k</span><br><span class="line">                    cy  = (i + <span class="number">0.5</span>) / f_k</span><br><span class="line">                    <span class="comment">#aspect_ratio: 1</span></span><br><span class="line">                    mean += [cx,cy,s_k,s_k]</span><br><span class="line">                    mean += [cx,cy,s_k_prime,s_k_prime]</span><br><span class="line">                    <span class="keyword">for</span> ar <span class="keyword">in</span> self.aspect_ratios[k]:</span><br><span class="line">                        mean += [cx,cy,s_k*sqrt(ar),s_k/sqrt(ar)]</span><br><span class="line">                        mean += [cx,cy,s_k/sqrt(ar),s_k*sqrt(ar)]</span><br><span class="line">            <span class="comment"># back to torch land</span></span><br><span class="line">            output = torch.Tensor(mean).view(<span class="number">-1</span>,<span class="number">4</span>)</span><br><span class="line">            <span class="keyword">if</span> self.clip:</span><br><span class="line">                output.clamp_(max=<span class="number">1</span>,min=<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SSD</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,phase,size,base,extras,head,num_classes)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        phase:  train,test</span></span><br><span class="line"><span class="string">        size:   ssdè¾“å…¥å›¾ç‰‡çš„å¤§å°ï¼Œä¹Ÿå³æ˜¯ç‰ˆæœ¬æŠŠ</span></span><br><span class="line"><span class="string">        base:   vggçš„ç½‘ç»œç»“æ„</span></span><br><span class="line"><span class="string">        extras: vggä¹‹åçš„é‚£äº›å±‚</span></span><br><span class="line"><span class="string">        head:   locï¼Œconf çš„boxes</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        super(SSD,self).__init__()</span><br><span class="line">        self.phase       = phase</span><br><span class="line">        self.num_classes = num_classes</span><br><span class="line">        self.cfg         = (coco,voc)[num_classes == <span class="number">21</span>]  <span class="comment"># config.py ä¸­å¯¹æ•°æ®é›†çš„ä¸€äº›é…ç½®</span></span><br><span class="line">        self.priorbox    = PriorBox(self.cfg)</span><br><span class="line">        self.priors      = Variable(self.priorbox.forward(),volatile=<span class="keyword">True</span>)</span><br><span class="line">        self.size        = size</span><br><span class="line"></span><br><span class="line">        <span class="comment">## ssd net</span></span><br><span class="line">        self.vgg         = nn.ModuleList(base)</span><br><span class="line">        self.L2Norm      = L2Norm(<span class="number">512</span>,<span class="number">20</span>)</span><br><span class="line">        self.extras      = nn.ModuleList(head[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        self.loc         = nn.ModuleList(head[<span class="number">0</span>])</span><br><span class="line">        self.conf        = nn.ModuleList(head[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> phase == <span class="string">'test'</span>:</span><br><span class="line">            self.softmax = nn.Softmax(dim = <span class="number">-1</span>)</span><br><span class="line">            <span class="comment">## detection.py</span></span><br><span class="line">            self.detect  = Detect(num_classes,<span class="number">0</span>,<span class="number">200</span>,<span class="number">0.01</span>,<span class="number">0.45</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self,x)</span>:</span></span><br><span class="line">        sources = list()</span><br><span class="line">        loc     = list()</span><br><span class="line">        conf    = list()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># apply vgg to conv4_3 relu</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">23</span>):</span><br><span class="line">            x = self.vgg[k](x)</span><br><span class="line">        s = self.L2Norm(x)</span><br><span class="line">        sources.append(s)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># apply vgg up to fc7</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">23</span>,len(self.vgg)):</span><br><span class="line">            x = self.vgg[k](x)</span><br><span class="line">        sources.append(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># apply extra layers</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> enumerate(self,extras):</span><br><span class="line">            x = F.relu(v(x),inplace=<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">if</span> k%<span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">                sources.append(x)</span><br><span class="line">        <span class="keyword">for</span> (x,l,c) <span class="keyword">in</span> zip(sources,self.loc,self.conf):</span><br><span class="line">            loc.append(l(x).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>).contiguous())</span><br><span class="line">            conf.append(c(x).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>).contiguous())</span><br><span class="line"></span><br><span class="line">        loc  = torch.cat([o.view(o.size(<span class="number">0</span>),<span class="number">-1</span>) <span class="keyword">for</span> o <span class="keyword">in</span> loc],<span class="number">1</span>)</span><br><span class="line">        conf = torch.cat([o.view(o.size(<span class="number">0</span>),<span class="number">-1</span>) <span class="keyword">for</span> o <span class="keyword">in</span> conf],<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> self,phase == <span class="string">'test'</span>:</span><br><span class="line">            output = self.detect(</span><br><span class="line">                loc.vire(loc.size(<span class="number">0</span>),<span class="number">-1</span>,<span class="number">4</span>),</span><br><span class="line">                self.softmax(conf.view(conf.size(<span class="number">0</span>),<span class="number">-1</span>,self.num_classes)),</span><br><span class="line">                self.priors.type(type(x.data))</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output = (</span><br><span class="line">                loc.view(loc.size(<span class="number">0</span>),<span class="number">-1</span>,<span class="number">4</span>),</span><br><span class="line">                conf,vire(conf.size(<span class="number">0</span>),<span class="number">-1</span>,self.num_classes),</span><br><span class="line">                self.priors</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_weights</span><span class="params">(self,base_file)</span>:</span></span><br><span class="line">        other,ext = os.path.splitext(base_file)</span><br><span class="line">        <span class="keyword">if</span> ext == <span class="string">'.pkl'</span> <span class="keyword">or</span> <span class="string">'.pth'</span>:</span><br><span class="line">            self.load_state_dict(torch.load(base_file,</span><br><span class="line">                                            map_location=<span class="keyword">lambda</span> storage,loc:storage))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'sorry wrong'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_ssd</span><span class="params">(phase,size=<span class="number">300</span>,num_classes=<span class="number">21</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> phase != <span class="string">'test'</span> <span class="keyword">and</span> phase != <span class="string">'train'</span>:</span><br><span class="line">        print(<span class="string">'error'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> size != <span class="number">300</span>:</span><br><span class="line">        print(<span class="string">'error'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    base_,extras_,head_ = multibox(vgg(base[str(size)],<span class="number">3</span>),add_extras(extras[str(size)],<span class="number">1024</span>),</span><br><span class="line">                                  mbox[str(size)],num_classes)</span><br><span class="line">    <span class="keyword">return</span> SSD(phase,size,base_,extras_,head_,num_classes)</span><br></pre></td></tr></table></figure>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>WenHui Zhou</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="/2019/03/29/SSD-å¤ç°/">https://wenhui-zhou.github.io/2019/03/29/SSD-å¤ç°/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>| æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="&quot;http://creativecommons.org/licenses/by-nc-sa/3.0/cn/&quot;" rel="&quot;external" nofollow&quot;="" target="&quot;_blank&quot;">CC BY-NC-SA 3.0 CN</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼ </li></ul></div><br><div class="tags"><a href="/tags/æ·±åº¦å­¦ä¹ /">æ·±åº¦å­¦ä¹ </a></div><div class="post-nav"><a class="pre" href="/2019/03/29/pytorch-åŸºæœ¬è¯­æ³•/">pytorch åŸºæœ¬è¯­æ³•</a><a class="next" href="/2019/03/22/æ‰‹æ’•mAP/">æ‰‹æ’•mAP</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'civq9nKD49NpRALooR9Llqmf-gzGzoHsz',
  appKey:'JggO9HaSi1Lfx17nt16oDfsI',
  placeholder:'Shall we talk',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tensorflow/">Tensorflow</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/super-resolution/">super resolution</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/xigua/">xigua</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å»ºç«™/">å»ºç«™</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ‰‹æ’•ç³»åˆ—/">æ‰‹æ’•ç³»åˆ—</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ¨¡å‹è¯„ä»·/">æ¨¡å‹è¯„ä»·</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ¯”èµ›/">æ¯”èµ›</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç®—æ³•æ‰«ç›²/">ç®—æ³•æ‰«ç›²</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç¼–ç¨‹/">ç¼–ç¨‹</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/è®ºæ–‡å¤ç°/">è®ºæ–‡å¤ç°</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/è®ºæ–‡é˜…è¯»/">è®ºæ–‡é˜…è¯»</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/é¡¹ç›®/">é¡¹ç›®</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/é¡¹ç›®æ€»ç»“/">é¡¹ç›®æ€»ç»“</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/é¡¹ç›®æ€»ç»“/è®ºæ–‡é˜…è¯»/">è®ºæ–‡é˜…è¯»</a><span class="category-list-count">3</span></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/interview/" style="font-size: 15px;">interview</a> <a href="/tags/dialog/" style="font-size: 15px;">dialog</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/æ·±åº¦å­¦ä¹ /" style="font-size: 15px;">æ·±åº¦å­¦ä¹ </a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/netStation/" style="font-size: 15px;">netStation</a> <a href="/tags/c/" style="font-size: 15px;">c++</a> <a href="/tags/tip/" style="font-size: 15px;">tip</a> <a href="/tags/Tensorflow/" style="font-size: 15px;">Tensorflow</a> <a href="/tags/â€”-leetcode/" style="font-size: 15px;">â€” leetcode</a> <a href="/tags/tips/" style="font-size: 15px;">tips</a> <a href="/tags/ç®—æ³•/" style="font-size: 15px;">ç®—æ³•</a> <a href="/tags/è®ºæ–‡é˜…è¯»/" style="font-size: 15px;">è®ºæ–‡é˜…è¯»</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/25/å“ˆå¸Œè¡¨-pythonç¤ºä¾‹/">å“ˆå¸Œè¡¨,pythonç¤ºä¾‹</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/22/å †æ’åºï¼Œpythonå®ç°/">å †æ’åºï¼Œpythonå®ç°</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/16/æ·±åº¦å­¦ä¹ ä»£ç çš„æ¡†æ¶/">æ·±åº¦å­¦ä¹ ä»£ç çš„æ¡†æ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/24/normalization/">normalization</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/image-upsample-downsample-method/">image upsample-downsample method</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/Deep-Learning-for-image-Super-resolution-a-Survey/">Deep Learning for image Super-resolution: a Survey</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/ä¸€äº›æå‡æ•ˆç‡çš„æ–¹æ³•/">ä¸€äº›æå‡æ•ˆç‡çš„æ–¹æ³•</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/xigua-æ”¯æŒå‘é‡æœº/">xigua-æ”¯æŒå‘é‡æœº</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/20/xigua-ç¥ç»ç½‘ç»œ/">xigua-ç¥ç»ç½‘ç»œ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/19-7-2019-preview/">19/7/2019 preview</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="https://github.com/WenHui-Zhou" title="GITHUB" target="_blank">GITHUB</a><ul></ul><a href="http://www.google.com/" title="GOOGLE" target="_blank">GOOGLE</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2019 <a href="/." rel="nofollow">WenHuiZhou.</a> è®¿é—®äººæ•°:<span id="busuanzi_value_site_uv"></span> 
è®¿é—®é‡:<span id="busuanzi_value_site_pv"></span></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> </div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>